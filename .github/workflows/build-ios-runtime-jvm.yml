name: build-ios-runtime-jvm

on:
  workflow_dispatch:

jobs:
  prepare-runtime:
    runs-on: macos-14
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download JRE17 iOS artifact
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: PojavLauncherTeam/android-openjdk-build-multiarch
          workflow: build.yml
          workflow_conclusion: success
          branch: buildjre17-21
          name: jre17-ios-aarch64
          path: depends/jre17

      - name: Download JRE21 iOS artifact
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: PojavLauncherTeam/android-openjdk-build-multiarch
          workflow: build.yml
          workflow_conclusion: completed
          branch: buildjre17-21
          name: jre21-ios-aarch64
          path: depends/jre21

      - name: Download JRE8 iOS artifact
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: PojavLauncherTeam/android-openjdk-build-multiarch
          workflow: build.yml
          workflow_conclusion: success
          branch: buildjre8
          name: jre8-ios-aarch64
          path: depends/jre8

      - name: Download latest Amethyst IPA (fallback runtime source)
        continue-on-error: true
        run: |
          mkdir -p depends/amethyst
          python3 - << 'PY'
          import json
          import os
          import urllib.request

          api = "https://api.github.com/repos/AngelAuraMC/Amethyst-iOS/releases/latest"
          with urllib.request.urlopen(api) as r:
              data = json.load(r)

          assets = data.get("assets", [])
          chosen = None
          for a in assets:
              name = (a.get("name") or "").lower()
              if name.endswith(".ipa") or name.endswith(".tipa"):
                  chosen = a
                  break

          if not chosen:
              print("No IPA/TIPA asset found in latest Amethyst release")
              raise SystemExit(0)

          url = chosen.get("browser_download_url")
          out = os.path.join("depends", "amethyst", chosen.get("name") or "amethyst.ipa")
          print(f"Downloading {url} -> {out}")
          with urllib.request.urlopen(url) as r, open(out, "wb") as f:
              f.write(r.read())
          PY

      - name: Prepare runtime import bundle
        run: |
          chmod +x ios/scripts/prepare_ios_runtime_import.sh
          ios/scripts/prepare_ios_runtime_import.sh

      - name: Upload runtime import zip
        uses: actions/upload-artifact@v4
        with:
          name: zomdroid-ios-runtime-import
          path: artifacts/runtime-import/runtime-import.zip
          if-no-files-found: error

      - name: Upload runtime summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zomdroid-ios-runtime-summary
          path: artifacts/runtime-import/runtime-summary.txt
          if-no-files-found: warn
